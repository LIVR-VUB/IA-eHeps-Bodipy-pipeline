Bootstrap: docker
From: nvidia/cuda:12.4.1-cudnn-devel-ubuntu22.04

%labels
    Author          LIVR-VUB / ImageD
    Description     EPCAM–OCT4 segmentation & quantification (Cellpose-SAM)
    Version         1.0
    Date            2025-11-06

%environment
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8
    export DEBIAN_FRONTEND=noninteractive
    export PYTHONUNBUFFERED=1
    export PATH="/opt/epcam_oct4/bin:$PATH"
    export PYTHONPATH="/opt/epcam_oct4/lib/python3.11/site-packages:$PYTHONPATH"

%post
    set -eux

    # ---------------- Base system ----------------
    apt-get update && apt-get install -y --no-install-recommends \
        python3.11 python3.11-venv python3.11-dev \
        git wget curl unzip build-essential pkg-config \
        openjdk-17-jre-headless libgl1 libglib2.0-0 ca-certificates \
        && rm -rf /var/lib/apt/lists/*

    # ---------------- Python virtual env ----------------
    python3.11 -m venv /opt/epcam_oct4
    . /opt/epcam_oct4/bin/activate
    pip install --upgrade pip wheel setuptools

    # ---------------- Core packages ----------------
    pip install --index-url https://download.pytorch.org/whl/cu124 \
        torch torchvision torchaudio

    # Cellpose (with SAM support)
    pip install "cellpose>=4.0.1" "tifffile>=2024.2"

    # CZI + BioFormats support (pin aicsimageio to avoid fsspec conflicts)
    pip install "aicsimageio==4.14.0" aicspylibczi czifile bfio jpype1

    # Utilities
    pip install pyyaml numpy pandas scikit-image matplotlib seaborn

    # ---------------- Install pipeline scripts ----------------
    mkdir -p /opt/epcam_oct4/pipeline
    # Copy at build time from the build context directory
    cp run_epcam_oct4_pipeline_single_model.py /opt/epcam_oct4/pipeline/ || true
    cp analysis.py /opt/epcam_oct4/pipeline/ || true
    chmod +x /opt/epcam_oct4/pipeline/*.py || true

    echo "Container build complete."

%runscript
    # Default entrypoint: activates venv and passes args
    . /opt/epcam_oct4/bin/activate
    exec "$@"

%help
    -------------------------------------------------------------------------
    EPCAM–OCT4 Segmentation & Quantification Container
    -------------------------------------------------------------------------
    Usage:
        apptainer run --nv \
          -B /your/project:/work \
          cp2M_quant.sif \
          python /work/run_epcam_oct4_pipeline_single_model.py /work/config.yaml

    Environment:
        Python 3.11, PyTorch (cu124) + CUDA 12.4.1
        Cellpose 4.x (SAM)
        aicsimageio==4.14.0, aicspylibczi, czifile, bfio (CZI support)
    -------------------------------------------------------------------------
